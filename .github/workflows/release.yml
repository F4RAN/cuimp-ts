name: Release

on:
  push:
    tags:
      - 'v*' # Triggered when pushing v* tags (e.g., v1.3.0)

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests
        run: npm run test:run
        
      - name: Build
        run: npm run build
        
      - name: Create Release Archive
        run: |
          mkdir -p release
          cp -r dist release/
          cp package.json release/
          cp package-lock.json release/
          cp README.md release/
          cp tsconfig.json release/
          cp LICENSE release/ 2>/dev/null || true
          cd release
          tar -czf ../cuimp-ts-${{ github.ref_name }}.tar.gz .
          
      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"  # Remove 'v' prefix
          
          # Get all tags and find the previous one
          git fetch --tags 2>/dev/null || true
          ALL_TAGS=$(git tag -l --sort=-version:refname | grep -E '^v[0-9]')
          PREV_TAG=$(echo "$ALL_TAGS" | grep -A1 "^${VERSION}$" | tail -1 || echo "")
          
          # Generate release notes from git commits since last tag
          echo "## What's Changed" > /tmp/release_notes.txt
          echo "" >> /tmp/release_notes.txt
          
          if [ -z "$PREV_TAG" ]; then
            # No previous tag, show last 20 commits
            git log --pretty=format:"- %s (%h)" --no-merges -20 >> /tmp/release_notes.txt || echo "- Initial release" >> /tmp/release_notes.txt
          else
            # Show commits since previous tag
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges ${PREV_TAG}..${VERSION})
            if [ -z "$COMMITS" ]; then
              echo "- No changes detected" >> /tmp/release_notes.txt
            else
              echo "$COMMITS" >> /tmp/release_notes.txt
            fi
          fi
          
          echo "" >> /tmp/release_notes.txt
          
          # Add installation instructions
          cat >> /tmp/release_notes.txt << EOF
          
          ## Installation Methods
          
          ### Recommended: Install directly from GitHub
          
          npm will automatically build from source (via prepare script):
          
          \`\`\`bash
          npm install github:F4RAN/cuimp-ts#${VERSION}
          \`\`\`
          
          Or in \`package.json\`:
          
          \`\`\`json
          {
            "dependencies": {
              "cuimp": "github:F4RAN/cuimp-ts#${VERSION}"
            }
          }
          \`\`\`
          
          ### Alternative: Manual installation (pre-built)
          
          If you don't want automatic building, download \`cuimp-ts-${VERSION}.tar.gz\` (includes dist):
          
          \`\`\`bash
          wget https://github.com/F4RAN/cuimp-ts/releases/download/${VERSION}/cuimp-ts-${VERSION}.tar.gz
          tar -xzf cuimp-ts-${VERSION}.tar.gz -C ./cuimp
          npm install ./cuimp
          \`\`\`
          EOF
          
          # Output for use in next step
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: cuimp-ts-${{ github.ref_name }}.tar.gz
          generate_release_notes: false
          body: ${{ steps.release_notes.outputs.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
